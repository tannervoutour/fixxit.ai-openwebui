# Production Deployment Checklist

Use this checklist when you're ready to deploy to production (app.fixxit.ai).

---

## Pre-Deployment Verification

- [ ] Dev environment (dev.fixxit.ai) is working correctly
- [ ] All recent changes have been tested on dev
- [ ] Database encryption key is documented and backed up
- [ ] You have SSH access to the server (18.204.97.97)

---

## Deployment Steps

### 1. Copy Directory Structure
```bash
ssh -i ~/.ssh/lightsail-key.pem ec2-user@18.204.97.97

cd /home/ec2-user

# Copy dev to production directory
rsync -av --exclude='logs/*' --exclude='*.pyc' --exclude='__pycache__' \
      --exclude='node_modules' --exclude='.git' \
      fixxit.ai-openwebui/ fixxit.ai-openwebui-prod/

# Verify copy
ls -la fixxit.ai-openwebui-prod/
```

- [ ] Directory copied successfully
- [ ] Verified directory structure matches dev

### 2. Update Configuration for Production

```bash
cd /home/ec2-user/fixxit.ai-openwebui-prod

# Update ports in start_server.sh
sed -i 's/BACKEND_PORT=8080/BACKEND_PORT=8081/g' start_server.sh
sed -i 's/FRONTEND_PORT=5173/FRONTEND_PORT=5174/g' start_server.sh

# Verify changes
grep -E 'BACKEND_PORT|FRONTEND_PORT' start_server.sh
```

- [ ] Ports updated to 8081/5174
- [ ] Changes verified

### 3. Setup Production Environment

```bash
cd /home/ec2-user/fixxit.ai-openwebui-prod

# Create fresh logs directory
mkdir -p logs
chmod 755 logs

# Rebuild Python virtual environment
cd backend
rm -rf venv  # Remove old venv
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
deactivate

# Install frontend dependencies
cd /home/ec2-user/fixxit.ai-openwebui-prod
npm install
```

- [ ] Logs directory created
- [ ] Python venv rebuilt
- [ ] Frontend dependencies installed

### 4. Verify Critical Configuration

```bash
# Verify encryption key is present
cat /home/ec2-user/fixxit.ai-openwebui-prod/backend/.env | grep DATABASE_PASSWORD_ENCRYPTION_KEY

# Should output:
# DATABASE_PASSWORD_ENCRYPTION_KEY=ajZEaDE4QmUwQmlsRzVjVjBSWnJSamxTOXRXdGhYWVF1U2l4T3VQMkRLND0=
```

- [ ] Encryption key verified (matches dev)

### 5. Copy Database (Recommended)

```bash
# Copy dev database to production
cp /home/ec2-user/fixxit.ai-openwebui/backend/data/webui.db \
   /home/ec2-user/fixxit.ai-openwebui-prod/backend/data/webui.db

# Set permissions
chmod 644 /home/ec2-user/fixxit.ai-openwebui-prod/backend/data/webui.db
```

- [ ] Database copied from dev
- [ ] Permissions set correctly

### 6. Start Production Server

```bash
cd /home/ec2-user/fixxit.ai-openwebui-prod
./start_server.sh start

# Wait for startup (30-60 seconds)

# Check status
./start_server.sh status

# Check logs for errors
tail -f logs/backend.log
```

- [ ] Production server started
- [ ] No errors in logs
- [ ] Status shows servers running

### 7. Test Locally

```bash
# Test backend
curl http://localhost:8081/api/version

# Should return version information

# Test from your local machine
curl https://app.fixxit.ai/api/version
```

- [ ] Backend responds on port 8081
- [ ] HTTPS works via app.fixxit.ai
- [ ] SSL certificate generated by Caddy

### 8. Verify Dev Environment Still Works

```bash
cd /home/ec2-user/fixxit.ai-openwebui
./start_server.sh status

# If stopped, restart it
./start_server.sh start

# Test dev
curl https://dev.fixxit.ai/api/version
```

- [ ] Dev environment still running
- [ ] Dev site accessible at dev.fixxit.ai

### 9. Full Production Testing

From your browser, visit: https://app.fixxit.ai

**Authentication**:
- [ ] Can access login page
- [ ] Can login with existing user
- [ ] Can register new user (if enabled)

**User Management** (as admin):
- [ ] User Management tab loads
- [ ] Can view managed groups
- [ ] Can see pending users
- [ ] No 500 errors in console

**Invitations** (as manager or admin):
- [ ] Can create new invitation
- [ ] Invitation URL shows "app.fixxit.ai" (not dev.fixxit.ai)
- [ ] Can view existing invitations
- [ ] Can revoke/delete invitation

**Logs** (if configured):
- [ ] Logs page loads
- [ ] Logs display correctly
- [ ] No "Failed to decrypt password" errors

**Chat**:
- [ ] Can create new chat
- [ ] Can send messages
- [ ] Models load correctly

### 10. Monitor for Issues

```bash
# Watch production logs
ssh -i ~/.ssh/lightsail-key.pem ec2-user@18.204.97.97
tail -f /home/ec2-user/fixxit.ai-openwebui-prod/logs/backend.log

# Watch Caddy logs
journalctl -u caddy -f
```

- [ ] Monitor for first 30 minutes
- [ ] Check for any errors or warnings
- [ ] Verify users can access and use the site

---

## Post-Deployment

### Both Environments Running

You should now have:
- **Dev**: https://dev.fixxit.ai (port 8080/5173)
- **Production**: https://app.fixxit.ai (port 8081/5174)

### Process Management

```bash
# Check all processes
ps aux | grep -E "uvicorn|node" | grep -v grep

# You should see 4 processes:
# - 2 uvicorn workers for dev (port 8080)
# - 2 uvicorn workers for production (port 8081)
```

### Future Updates

When you update code:
1. Test on dev.fixxit.ai first
2. If successful, sync changes to production:
   ```bash
   rsync -av --exclude='logs/*' --exclude='*.pyc' \
         /home/ec2-user/fixxit.ai-openwebui/backend/open_webui/ \
         /home/ec2-user/fixxit.ai-openwebui-prod/backend/open_webui/

   cd /home/ec2-user/fixxit.ai-openwebui-prod
   ./start_server.sh restart
   ```

---

## Rollback Plan (If Something Goes Wrong)

If production deployment fails or has issues:

```bash
# Stop production server
cd /home/ec2-user/fixxit.ai-openwebui-prod
./start_server.sh stop

# Ensure dev is running
cd /home/ec2-user/fixxit.ai-openwebui
./start_server.sh start

# Point app.fixxit.ai to dev temporarily (if needed)
# Edit Caddyfile to proxy app.fixxit.ai to port 8080 instead of 8081
```

Then investigate the issue, fix, and try again.

---

## Success Criteria

âœ… Production is deployed successfully when:
- [ ] https://app.fixxit.ai loads without errors
- [ ] SSL certificate is valid (shows green lock in browser)
- [ ] All features work (auth, groups, invitations, logs, chat)
- [ ] No errors in backend logs
- [ ] No 500 errors in browser console
- [ ] Invitation URLs show "app.fixxit.ai"
- [ ] Dev environment (dev.fixxit.ai) still works normally

---

## Support Information

**Server**: AWS Lightsail (18.204.97.97)
**SSH Key**: `~/.ssh/lightsail-key.pem`
**Reverse Proxy**: Caddy (auto-configured)
**SSL**: Let's Encrypt (auto-managed by Caddy)

**Key Files**:
- Dev: `/home/ec2-user/fixxit.ai-openwebui`
- Production: `/home/ec2-user/fixxit.ai-openwebui-prod`
- Caddy Config: `/etc/caddy/Caddyfile`
- Encryption Key: In both `.env` files (MUST be identical)

**If You Need Help**:
1. Check logs: `tail -f /home/ec2-user/fixxit.ai-openwebui-prod/logs/backend.log`
2. Check Caddy: `journalctl -u caddy -f`
3. Check processes: `ps aux | grep -E "uvicorn|node"`
4. Refer to `PRODUCTION_DEPLOYMENT_PLAN.md` for detailed information
