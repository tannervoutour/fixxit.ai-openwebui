name: Sync with Upstream

on:
  schedule:
    # Run every Monday and Thursday at 7:00 AM UTC
    - cron: '0 7 * * 1,4'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/open-webui/open-webui.git
          git fetch upstream

      - name: Create/Update upstream-main branch
        run: |
          # Create or update upstream-main branch with latest upstream changes
          git checkout -B upstream-main upstream/main
          git push origin upstream-main --force

      - name: Check for conflicts with fixxit-main
        run: |
          # Switch to fixxit-main and attempt merge to check for conflicts
          git checkout fixxit-main 2>/dev/null || git checkout -b fixxit-main main
          
          # Attempt to merge upstream changes (this will fail if there are conflicts)
          if ! git merge upstream/main --no-commit --no-ff; then
            echo "MERGE_CONFLICTS=true" >> $GITHUB_ENV
            git merge --abort
          else
            echo "MERGE_CONFLICTS=false" >> $GITHUB_ENV
            git reset --hard HEAD  # Reset the merge without committing
          fi

      - name: Create Pull Request if no conflicts
        if: env.MERGE_CONFLICTS == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync with upstream OpenWebUI"
          title: "üîÑ Sync with upstream OpenWebUI"
          body: |
            ## Automated Upstream Sync
            
            This PR contains the latest changes from the upstream OpenWebUI repository.
            
            ### Changes included:
            - Latest commits from `open-webui/open-webui:main`
            - No merge conflicts detected
            
            ### Review checklist:
            - [ ] Review changed files for any breaking changes
            - [ ] Test locally if needed
            - [ ] Ensure fixxit.ai customizations are preserved
            
            **Auto-generated by GitHub Actions** ü§ñ
          branch: sync/upstream-auto
          base: fixxit-main
          delete-branch: true

      - name: Create Issue if conflicts detected
        if: env.MERGE_CONFLICTS == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: upstream sync conflicts detected"
          title: "‚ö†Ô∏è Manual intervention needed: Upstream sync conflicts"
          body: |
            ## Merge Conflicts Detected
            
            The automated sync with upstream OpenWebUI has detected merge conflicts that require manual resolution.
            
            ### Next steps:
            1. Checkout the `upstream-main` branch locally
            2. Merge `upstream-main` into `fixxit-main` manually
            3. Resolve any conflicts
            4. Test the changes
            5. Push the resolved changes
            
            ```bash
            git checkout fixxit-main
            git merge upstream-main
            # Resolve conflicts in your IDE
            git add .
            git commit -m "resolve: merge conflicts from upstream sync"
            git push origin fixxit-main
            ```
            
            **Auto-generated by GitHub Actions** ü§ñ
          branch: sync/conflicts-detected
          base: fixxit-main
          delete-branch: true